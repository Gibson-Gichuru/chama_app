version: '3.8'

services:

  nginx:

    build: 

      context: .

    ports:

      - "80:80"

    depends_on:
      - api

    volumes:
      - type: volume
        source: nginxLog
        target : /var/log/nginx

      - type: bind

        source: ./nginx/deployment/default.conf 

        target: /etc/nginx/conf.d/default.conf


  api:
    build: 
      context: ./api

    env_file:
      - .env
    # set up all the required environament  variables required by the api service
    environment:
    
      SECRET_KEY: "${SECRET_KEY}"
      ACTIVATION_KEY: "${ACTIVATION_KEY}"
      ACCESS_KEY: "${ACCESS_KEY}"
      REFRESH_KEY: "${REFRESH_KEY}"
      MARIADB_ROOT_PASSWORD: "${DATABASE_PASSWORD}"
      MAIL_PORT: "${MAIL_PORT}"
      MAIL_SENDER: "${MAIL_SENDER}"
      MAIL_SERVER: "${MAIL_SERVER}"
      MAIL_USERNAME: "${MAIL_USERNAME}"
      MAIL_PASSWORD: "${MAIL_PASSWORD}"
      REDIS_HOST: "${REDIS_HOST}"
      REDIS_PORT: 6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"

    depends_on:
      - database
      - redis
    volumes:

      - type : bind
        source: ./api
        target: /api
    # use gunicon to serve the  appication
    # command: flask run

    command: gunicorn --bind 0.0.0.0:5000 manage:app

  database:

    image: mariadb:10.7.4
    
    restart : always
    environment:  
    #  Setting up environament variables 
      MARIADB_ROOT_PASSWORD: "${DATABASE_ROOT_PASSWORD}"
  
    expose:

      - 3160

    volumes:

      - type : volume
        source : mysqlData
        target: /var/lib/mysql  



  redis:

    image: 'bitnami/redis:latest'

    restart: always

    environment:

      - REDIS_PASSWORD="${REDIS_PASSWORD}"
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL,CONFIG

    expose:
      - 6379

    volumes:

      - type : volume
        source: redisData
        target : /data

    
volumes:

  mysqlData:

    driver: local

  redisData:

    driver: local

  nginxLog:

    driver: local





